name: Build and Package Server

# 触发条件：当推送到 main 分支或创建 tag 时触发
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取源代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Node.js 环境 (用于前端打包)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # 根据你的需求选择版本
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 3. 安装后端编译依赖 (C++, CMake)
      - name: Install backend dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      # 4. 给脚本执行权限并运行构建脚本
      - name: Run build script
        run: |
          chmod +x build_server.sh
          ./build_server.sh

      # 5. 打包构建产物 (为了方便下载，先压缩一下)
      - name: Create Tarball
        run: |
          tar -czvf server-build.tar.gz build_server/

      # 6. 上传 Artifact (在 GitHub Action 页面可以直接下载)
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-linux-x64
          path: server-build.tar.gz

      # 7. (可选) 如果推送到的是 tag，则自动创建 Release
      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: server-build.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}